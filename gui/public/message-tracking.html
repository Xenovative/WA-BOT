<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨Šæ¯è¿½è¹¤è¨˜éŒ„ - Message Tracking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            flex: 1;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card.total {
            background-color: #e3f2fd;
            border: 2px solid #2196F3;
        }
        .stat-card.sent {
            background-color: #e8f5e9;
            border: 2px solid #4CAF50;
        }
        .stat-card.failed {
            background-color: #ffebee;
            border: 2px solid #f44336;
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn.secondary {
            background-color: #2196F3;
        }
        .btn.secondary:hover {
            background-color: #0b7dda;
        }
        .search-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-sent {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        .status-failed {
            background-color: #ffcdd2;
            color: #c62828;
        }
        .message-preview {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .message-preview:hover {
            color: #2196F3;
            text-decoration: underline;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        .close:hover {
            color: #333;
        }
        .message-full {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¼ è¨Šæ¯è¿½è¹¤è¨˜éŒ„</h1>
        <p class="subtitle">Message Tracking History</p>
        
        <div class="stats">
            <div class="stat-card total">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">ç¸½è¨Šæ¯æ•¸</div>
            </div>
            <div class="stat-card sent">
                <div class="stat-number" id="sentCount">0</div>
                <div class="stat-label">å·²ç™¼é€</div>
            </div>
            <div class="stat-card failed">
                <div class="stat-number" id="failedCount">0</div>
                <div class="stat-label">ç™¼é€å¤±æ•—</div>
            </div>
        </div>
        
        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="æœå°‹å®¢æˆ¶åç¨±æˆ–è¨Šæ¯å…§å®¹...">
            <div>
                <button class="btn secondary" onclick="loadTracking()">ğŸ”„ é‡æ–°æ•´ç†</button>
                <button class="btn" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡º CSV</button>
            </div>
        </div>
        
        <div id="spinner" class="spinner" style="display: none;"></div>
        
        <div id="tableContainer"></div>
    </div>

    <!-- Message Detail Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">è¨Šæ¯è©³æƒ…</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        let trackingData = [];
        let filteredData = [];

        // Load tracking data on page load
        window.onload = () => {
            loadTracking();
            
            // Search functionality
            document.getElementById('searchBox').addEventListener('input', (e) => {
                filterData(e.target.value);
            });
        };

        async function loadTracking() {
            const spinner = document.getElementById('spinner');
            const tableContainer = document.getElementById('tableContainer');
            
            spinner.style.display = 'block';
            tableContainer.innerHTML = '';
            
            try {
                const response = await fetch('/api/workflow/message-tracking');
                const result = await response.json();
                
                if (result.success) {
                    trackingData = result.tracking.reverse(); // Show newest first
                    filteredData = trackingData;
                    updateStats();
                    renderTable();
                } else {
                    tableContainer.innerHTML = '<p style="color: red;">è¼‰å…¥å¤±æ•—ï¼š' + result.error + '</p>';
                }
            } catch (error) {
                tableContainer.innerHTML = '<p style="color: red;">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</p>';
            } finally {
                spinner.style.display = 'none';
            }
        }

        function updateStats() {
            const total = trackingData.length;
            const sent = trackingData.filter(t => t.status === 'sent').length;
            const failed = trackingData.filter(t => t.status === 'failed').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('sentCount').textContent = sent;
            document.getElementById('failedCount').textContent = failed;
        }

        function filterData(searchTerm) {
            const term = searchTerm.toLowerCase();
            filteredData = trackingData.filter(item => 
                item.customerName.toLowerCase().includes(term) ||
                item.message.toLowerCase().includes(term) ||
                item.customerId.toLowerCase().includes(term)
            );
            renderTable();
        }

        function renderTable() {
            const tableContainer = document.getElementById('tableContainer');
            
            if (filteredData.length === 0) {
                tableContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>å°šç„¡è¨Šæ¯è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>å®¢æˆ¶åç¨±</th>
                            <th>å®¢æˆ¶ ID</th>
                            <th>è¨Šæ¯é è¦½</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredData.forEach((item, index) => {
                const statusClass = item.status === 'sent' ? 'status-sent' : 'status-failed';
                const statusText = item.status === 'sent' ? 'å·²ç™¼é€' : 'å¤±æ•—';
                const preview = item.message.substring(0, 50) + (item.message.length > 50 ? '...' : '');
                
                html += `
                    <tr>
                        <td>${item.date}</td>
                        <td><strong>${item.customerName}</strong></td>
                        <td style="font-size: 12px; color: #666;">${item.customerId}</td>
                        <td class="message-preview" onclick="showMessage(${index})">${preview}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = html;
        }

        function showMessage(index) {
            const item = filteredData[index];
            const modal = document.getElementById('messageModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `è¨Šæ¯è©³æƒ… - ${item.customerName}`;
            modalBody.innerHTML = `
                <p><strong>å®¢æˆ¶åç¨±ï¼š</strong>${item.customerName}</p>
                <p><strong>å®¢æˆ¶ IDï¼š</strong>${item.customerId}</p>
                <p><strong>ç™¼é€æ™‚é–“ï¼š</strong>${item.date}</p>
                <p><strong>ç‹€æ…‹ï¼š</strong>${item.status === 'sent' ? 'âœ… å·²ç™¼é€' : 'âŒ å¤±æ•—'}</p>
                <p><strong>è¨Šæ¯å…§å®¹ï¼š</strong></p>
                <div class="message-full">${item.message}</div>
            `;
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('messageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        function exportCSV() {
            if (trackingData.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }
            
            let csv = '\uFEFF'; // UTF-8 BOM for Excel
            csv += 'æ™‚é–“,å®¢æˆ¶åç¨±,å®¢æˆ¶ID,è¨Šæ¯å…§å®¹,ç‹€æ…‹\n';
            
            trackingData.forEach(item => {
                const message = item.message.replace(/"/g, '""'); // Escape quotes
                csv += `"${item.date}","${item.customerName}","${item.customerId}","${message}","${item.status}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `message_tracking_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
